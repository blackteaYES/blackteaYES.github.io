import{_ as p,V as o,W as i,X as s,Y as n,$ as t,a0 as e,C as r}from"./framework-a71e09ed.js";const l="/assets/img/ElasticStack/ELK架构图.png",c="/assets/img/ElasticStack/ElasticStack架构图.png",u="/assets/img/ElasticStack/建立term索引库.png",d="/assets/img/ElasticStack/Elasticsearch.png",k="/assets/img/ElasticStack/lucene-es部署.png",v="/assets/img/ElasticStack/Elasticsearch的特点.png",m="/assets/img/ElasticStack/Elasticsearch交互.png",b="/assets/img/ElasticStack/es核心概念.png",q="/assets/img/ElasticStack/不同数据放到不同索引中.png",h="/assets/img/ElasticStack/全量替换图.png",g="/assets/img/ElasticStack/图解局部更新内部原理.png",y="/assets/img/ElasticStack/ES并发问题.png",_="/assets/img/ElasticStack/图解es内部主从同步并发控制.png",f="/assets/img/ElasticStack/图解es分布式基础.png",x="/assets/img/ElasticStack/设置分片插件可视化效果.png",j="/assets/img/ElasticStack/图解单node环境下创建index是什么样子的.png",E="/assets/img/ElasticStack/图解2个node环境下replica_shard是如何分配的.png",S="/assets/img/ElasticStack/图解横向扩容.png",w="/assets/img/ElasticStack/图解es容错机制masteri选举，replica容错，数据恢复.png",T="/assets/img/ElasticStack/图解文档存储机制.png",P="/assets/img/ElasticStack/图解文档的增删改内部机制.png",z="/assets/img/ElasticStack/图解文档的查询内部机制.png",L={},B=s("h1",{id:"elastic-stack",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#elastic-stack","aria-hidden":"true"},"#"),n(" Elastic Stack")],-1),A=s("h2",{id:"elastic-stack-简介",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#elastic-stack-简介","aria-hidden":"true"},"#"),n(" Elastic Stack 简介")],-1),M={href:"https://www.elastic.co/cn/",target:"_blank",rel:"noopener noreferrer"},N=e('<figure><img src="'+l+'" alt="ELK架构图" tabindex="0" loading="lazy"><figcaption>ELK架构图</figcaption></figure><p>随着elk的发展，又有新成员Beats、elastic cloud的加入，所以就形成了 Elastic Stack。所以说，ELK是I旧的称呼，Elastic Stack是新的名字。</p><figure><img src="'+c+'" alt="ElasticStack架构图" tabindex="0" loading="lazy"><figcaption>ElasticStack架构图</figcaption></figure><h2 id="elastic-stack特色" tabindex="-1"><a class="header-anchor" href="#elastic-stack特色" aria-hidden="true">#</a> Elastic Stack特色</h2><ul><li><p>处理方式灵活：elasticsearch是目前最流行的准实时全文检索引擎，具有 高速检索大数据的能力。</p></li><li><p>配置简单：安装k的每个组件，仅需配置每个组件的一个配置文件即可。</p><p>修改处不多，因为大量参数已经默认配在系统中，修改想要修改的选项即 可。</p></li><li><p>接口简单：采用json形式RESTFUL API接受数据并响应，无关语言。</p></li><li><p>性能高效：elasticsearch:基于优秀的全文搜索技术Lucene,采用倒排索 引，可以轻易地在百亿级别数据量下，搜索出想要的内容，并且是秒级响 应。</p></li><li><p>灵活扩展：elasticsearchi和logstash都可以根据集群规模线性拓展， elasticsearch内部自动实现集群协作。</p></li><li><p>数据展现华丽：kibana作为前端展现工具，图表华丽，配置简单。</p></li></ul><h2 id="elastic-stack组件介绍" tabindex="-1"><a class="header-anchor" href="#elastic-stack组件介绍" aria-hidden="true">#</a> Elastic Stack组件介绍</h2><h3 id="elasticsearch" tabindex="-1"><a class="header-anchor" href="#elasticsearch" aria-hidden="true">#</a> Elasticsearch</h3><p>Elasticsearch是使用java开发，基于Lucene、分布式、通过Restful)方式进行 交互的近实时搜索平台框架。它的特点有：分布式，零配置，自动发现，索引自动 分片，索引副本机制，restful风格接口，多数据源，自动搜索负载等。</p><h3 id="logstash" tabindex="-1"><a class="header-anchor" href="#logstash" aria-hidden="true">#</a> Logstash</h3><p>Logstash基于java开发，是一个数据抽取转化工具。一般工作方式为c/s架 构，clienti端安装在需要收集信息的主机上，serveri端负责将收到的各节点日志进 行过滤、修改等操作在一并发往elasticsearch或其他组件上去。</p><h3 id="kibana" tabindex="-1"><a class="header-anchor" href="#kibana" aria-hidden="true">#</a> Kibana</h3><p>Kibana基于nodejs,也是一个开源和免费的可视化工具。Kibanai可以为 Logstash和ElasticSearch提供的日志分析友好的Web界面，可以汇总、分析和 搜索重要数据日志。</p><h3 id="beats" tabindex="-1"><a class="header-anchor" href="#beats" aria-hidden="true">#</a> Beats</h3><p>Beats平台集合了多种单一用途数据采集器。它们从成百上千或成千上万台机 器和系统向Logstash或Elasticsearch发送数据。</p><h4 id="beats由如下组成" tabindex="-1"><a class="header-anchor" href="#beats由如下组成" aria-hidden="true">#</a> Beats由如下组成</h4><h5 id="packetbeat" tabindex="-1"><a class="header-anchor" href="#packetbeat" aria-hidden="true">#</a> Packetbeat</h5><p>轻量型网络数据采集器，用于深挖网线上传输的数据，了解应 用程序动态。Packetbeat是一款轻量型网络数据包分析器，能够将数据发送至 Logstash或Elasticsearch。其支持ICMP(v4andv6)、DNS、HTTP、Mysql.. PostgreSQL、Redis、MongoDB、Memcache等t协议。</p><h5 id="filebeat" tabindex="-1"><a class="header-anchor" href="#filebeat" aria-hidden="true">#</a> Filebeat</h5><p>轻量型日志采集器。当您要面对成百上千、甚至成千上万的服务 器、虚拟机和容器生成的日志时，请告别SSH吧。Filebeat将为您提供一种轻量型 方法，用于转发和汇总日志与文件，让简单的事情不再繁杂。</p><h5 id="metricbeat" tabindex="-1"><a class="header-anchor" href="#metricbeat" aria-hidden="true">#</a> Metricbeat</h5><p>轻量型指标采集器。Metricbeat能够以一种轻量型的方式， 输送各种系统和服务统计数据，从CPU到内存，从Redis到Nginx,不一而足。 可定期获取外部系统的监控指标信息，其可以监控、收集Apache http、 HAProxy、MongoDB、MySQL、Nginx、PostgreSQL、Redis、System Zookeeper等服务。</p><h5 id="winlogbeat" tabindex="-1"><a class="header-anchor" href="#winlogbeat" aria-hidden="true">#</a> Winlogbeat</h5><p>轻量型Windows事件日志采集器。用于密切监控基于 Windows的基础设施上发生的事件。Winlogbeat能够以一种轻量型的方式，将 Windows事件日志实时地流式传输至Elasticsearch和Logstash。</p><h5 id="auditbeat" tabindex="-1"><a class="header-anchor" href="#auditbeat" aria-hidden="true">#</a> Auditbeat</h5><p>轻量型审计日志采集器。收集您Linux审计框架的数据，监控 文件完整性。Auditbeat实时采集这些事件，然后发送到Elastic Stack其他部分做 进一步分析。</p><h5 id="heartbeat" tabindex="-1"><a class="header-anchor" href="#heartbeat" aria-hidden="true">#</a> Heartbeat</h5><p>面向运行状态监测的轻量型采集器。通过主动探测来监测服务 的可用性。通过给定URL列表，Heartbeat仅仅询问：网站运行正常吗？ Heartbeat会将此信息和响应时间发送至Elastic的其他部分，以进行进一步分 析。</p><h5 id="functionbeat" tabindex="-1"><a class="header-anchor" href="#functionbeat" aria-hidden="true">#</a> Functionbeat</h5><p>面向云端数据的无服务器采集器。在作为一项功能部署在云 服务提供商的功能即服务(FaaS)平台上后，Functionbeat即能收集、传送并监测 来自您的云服务的相关数据。</p><h3 id="elastic-cloud" tabindex="-1"><a class="header-anchor" href="#elastic-cloud" aria-hidden="true">#</a> Elastic cloud</h3><p>基于Elasticsearch的软件即服务(Saas)解决方案。通过Elastic的官方合作伙 伴使用托管的Elasticsearch服务。</p><h2 id="elasticsearch是什么" tabindex="-1"><a class="header-anchor" href="#elasticsearch是什么" aria-hidden="true">#</a> Elasticsearch是什么</h2><h3 id="搜索是什么" tabindex="-1"><a class="header-anchor" href="#搜索是什么" aria-hidden="true">#</a> 搜索是什么？</h3><p>概念：用户输入想要的关键词，返回含有该关键词的所有信息。 场景：</p><ul><li>互联网搜索：谷歌、百度、各种新闻首页；</li><li>站内搜索（垂直搜索）：企业OA查询订单、人员、部门，电商网站内部搜索商品（淘宝、京东）场景。</li></ul><h3 id="数据库做搜索弊端" tabindex="-1"><a class="header-anchor" href="#数据库做搜索弊端" aria-hidden="true">#</a> 数据库做搜索弊端</h3><h4 id="站内搜索-垂直搜索" tabindex="-1"><a class="header-anchor" href="#站内搜索-垂直搜索" aria-hidden="true">#</a> 站内搜索（垂直搜索）</h4><p>数据量小，简单搜索，可以使用数据库。</p><h5 id="问题出现" tabindex="-1"><a class="header-anchor" href="#问题出现" aria-hidden="true">#</a> 问题出现</h5><ul><li><p>存储问题。</p><p>电商网站商品上亿条时，涉及到单表数据过大必须拆分表，数据 库磁盘占用过大必须分库(mycat)。</p></li><li><p>性能问题。</p><p>解决上面问题后，查询“笔记本电脑”等关键词时，上亿条数据的 商品名字段逐行扫描，性能跟不上。</p></li><li><p>不能分词。</p><p>如搜索“笔记本电脑”，只能搜索完全和关键词一样的数据，那么 数据量小时，搜索“笔记电脑”，“电脑&quot;数据要不要给用户。</p></li></ul><h5 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h5><p>互联网搜索，肯定不会使用数据库搜索。数据量太大。PB级。</p><h3 id="全文检索、倒排索引和lucene" tabindex="-1"><a class="header-anchor" href="#全文检索、倒排索引和lucene" aria-hidden="true">#</a> 全文检索、倒排索引和Lucene</h3><h5 id="全文检索" tabindex="-1"><a class="header-anchor" href="#全文检索" aria-hidden="true">#</a> 全文检索</h5><p>倒排索引。数据存储时，经行分词建立term索引库。</p><figure><img src="'+u+'" alt="建立term索引库" tabindex="0" loading="lazy"><figcaption>建立term索引库</figcaption></figure><p>倒排索引源于实际应用中需要根据属性的值来查找记录。这种索引表中的每一 项都包括一个属性值和具有该属性值的各记录的地址。由于不是由记录来确定属性 值，而是由属性值来确定记录的位置，因而称为倒排索引(inverted index)。带有倒 排索引的文件我们称为倒排索引文件，简称倒排文件(inverted file)。</p><h5 id="lucene" tabindex="-1"><a class="header-anchor" href="#lucene" aria-hidden="true">#</a> Lucene</h5><p>就是一们r包，里面封装了全文检索的引擎、搜索的算法代码。开发时，引入 lucenel的jar包，通过api开发搜索相关业务。底层会在磁盘建立索引库。</p><h3 id="什么是elasticsearch" tabindex="-1"><a class="header-anchor" href="#什么是elasticsearch" aria-hidden="true">#</a> 什么是Elasticsearch</h3><h4 id="简介" tabindex="-1"><a class="header-anchor" href="#简介" aria-hidden="true">#</a> 简介</h4>',51),U={href:"https://www.elastic.co/cn/what-is/elasticsearch",target:"_blank",rel:"noopener noreferrer"},C=e('<figure><img src="'+d+'" alt="Elasticsearch" tabindex="0" loading="lazy"><figcaption>Elasticsearch</figcaption></figure><h4 id="elasticsearch的功能" tabindex="-1"><a class="header-anchor" href="#elasticsearch的功能" aria-hidden="true">#</a> Elasticsearch的功能</h4><ul><li><p>分布式的搜索引擎和数据分析引</p><p>搜索：互联网搜索、电商网站站内搜索、OA系统查询 数据分析：电商网站查询近一周哪些品类的图书销售前十：新闻网站，最近3 天阅读量最高的十个关键词，舆情分析。</p></li><li><p>全文检索，结构化检索，数据分析 全文检索：搜索商品名称包含java的图书select<em>from books where book_name like &quot;%java%&quot; 结构化检索：搜索商品分类为spring的图书都有哪些，select</em>from books where category_id=&#39;spring&#39; 数据分析：分析每一个分类下有多少种图书，select category_id,count(*) from books group by category_id</p></li><li><p>对海量数据进行近实时的处理 分布式：ES自动可以将海量数据分散到多台服务器上去存储和检索，经行并行查 询，提高搜索效率。相对的，Lucene是单机应用。 近实时：数据库上亿条数据查询，搜索一次耗时几个小时，是批处理(batch- processing)。而es只需秒级即可查询海量数据，所以叫近实时。秒级。</p></li></ul><figure><img src="'+k+'" alt="lucene-es部署" tabindex="0" loading="lazy"><figcaption>lucene-es部署</figcaption></figure><h4 id="elasticsearch-的使用场景" tabindex="-1"><a class="header-anchor" href="#elasticsearch-的使用场景" aria-hidden="true">#</a> Elasticsearch 的使用场景</h4><p>国外：</p><ul><li>维基百科，类似百度百科，“网络七层协议&quot;的维基百科，全文检索，高亮， 搜索推荐</li><li>Stack Overflow(国外的程序讨论论坛)，相当于程序员的贴吧。遇到it问 题去上面发帖，热心网友下面回帖解答。</li><li>GitHub(开源代码管理)，搜索上千亿行代码。</li><li>电商网站，检索商品</li><li>日志数据分析，logstash采集日志，ES进行复杂的数据分析(ELK技术， elasticsearch+logstash+kibana</li><li>商品价格监控网站，用户设定某商品的价格阈值，当低于该阈值的时候，发 送通知消息给用户，比如说订阅《jva编程思想》的监控，如果价格低于 27块钱，就通知我，我就去买。</li><li>BI系统，商业智能(Business Intelligence)。大型连锁超市，分析全国网 点传回的数据，分析各个商品在什么季节的销售量最好、利润最高。成本管 理，店面租金、员工工资、负债等信息进行分析。从而部署下一个阶段的战 略目标。</li></ul><p>国内：</p><ul><li>百度搜索，第一次查询，使用es。</li><li>OA、ERP系统站内搜索。</li></ul><h4 id="elasticsearch的特点" tabindex="-1"><a class="header-anchor" href="#elasticsearch的特点" aria-hidden="true">#</a> Elasticsearch的特点</h4><ul><li>可拓展性：大型分布式集群（数百台服务器）技术，处理PB级数据，大公 司可以使用。小公司数据量小，也可以部署在单机。大数据领域使用广泛。</li><li>技术整合：将全文检索、数据分析、分布式相关技术整合在一起： lucene(全文检索)，商用的数据分析软件（B软件)，分布式数据库 mycat</li><li>部署简单：开箱即用，很多默认配置不需关心，解压完成直接运行即可。拓 展时，只需多部署几个实例即可，负载均衡、分片迁移集群内部自己实施。</li><li>接口简单：使用restful api经行交互，跨语言。</li><li>功能强大：Elasticsearch作为传统数据库的一个补充，提供了数据库所不不 能提供的很多功能，如全文检索，同义词处理，相关度排名。</li></ul><figure><img src="'+v+'" alt="Elasticsearch的特点" tabindex="0" loading="lazy"><figcaption>Elasticsearch的特点</figcaption></figure><h3 id="elasticsearch-的核心概念" tabindex="-1"><a class="header-anchor" href="#elasticsearch-的核心概念" aria-hidden="true">#</a> Elasticsearch 的核心概念</h3><h4 id="lucene和elasticsearch的关系" tabindex="-1"><a class="header-anchor" href="#lucene和elasticsearch的关系" aria-hidden="true">#</a> lucene和elasticsearch的关系</h4><p>Lucene:最先进、功能最强大的搜索库，直接基于lucene开发，非常复杂， api复杂。 Elasticsearch:基于lucene,封装了许多ucene底层功能，提供简单易用的 restful api接口和许多语言的客户端，如java的高级客户端(Java High Level REST Client)和底层客户端(Java Low Level REST Client)</p><figure><img src="'+m+`" alt="Elasticsearch交互" tabindex="0" loading="lazy"><figcaption>Elasticsearch交互</figcaption></figure><p>起源：Shay Banon。2004年失业，陪老婆去伦敦学习厨师。失业在家帮老婆 写一个菜谱搜索引擎。封装了lucenet的开源项目，compass。找到工作后，做分布 式高性能项目，再封装compass,写出了elasticsearch,使得lucene，使得lucenet支持分布式。 现在是Elasticsearch创始人兼Elastic首席执行官。</p><h4 id="elasticsearch-的核心概念-1" tabindex="-1"><a class="header-anchor" href="#elasticsearch-的核心概念-1" aria-hidden="true">#</a> Elasticsearch 的核心概念</h4><h5 id="_1-nrt-near-realtime-近实时" tabindex="-1"><a class="header-anchor" href="#_1-nrt-near-realtime-近实时" aria-hidden="true">#</a> 1 NRT(Near Realtime):近实时</h5><ol><li>两方面： 写入数据时，过1秒才会被搜索到，因为内部在分词、录入索引。</li><li>es搜索时：搜索和分析数据需要秒级出结果。</li></ol><h5 id="_2-cluster-集群" tabindex="-1"><a class="header-anchor" href="#_2-cluster-集群" aria-hidden="true">#</a> 2 Cluster:集群</h5><p>包含一个或多个启动着es实例的机器群。通常一台机器起一个es实例。同一网 络下，集名一样的多个s实例自动组成集群，自动均衡分片等行为。默认集群名 为&quot;elasticsearch&quot;。</p><h5 id="_3-node-节点" tabindex="-1"><a class="header-anchor" href="#_3-node-节点" aria-hidden="true">#</a> 3 Node:节点</h5><p>每个s实例称为一个节点。节点名自动分配，也可以手动配置。</p><h5 id="_4-document-文档" tabindex="-1"><a class="header-anchor" href="#_4-document-文档" aria-hidden="true">#</a> 4 Document:文档</h5><p>es中的最小数据单元。一个documenti就像数据库中的一条记录。通常以)json 格式显示。多个document存储于一个索引(Index)中。</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>book document

<span class="token punctuation">{</span>
    <span class="token property">&quot;book_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;book_name&quot;</span><span class="token operator">:</span><span class="token string">&quot;java编程思想&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;book_desc&quot;</span><span class="token operator">:</span>&quot;从Java的基础语法到最高级特性（深入的<span class="token punctuation">[</span>面向对象<span class="token punctuation">]</span>(https<span class="token operator">:</span><span class="token comment">//baike.baidu.com/item/面向对象)概念、多线程、自动项目构	建、单元测试和调试等)，本书都能逐步指导你轻松学握。”,</span>
	<span class="token property">&quot;category_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;category_name&quot;</span><span class="token operator">:</span><span class="token string">&quot;java&quot;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-index-索引" tabindex="-1"><a class="header-anchor" href="#_5-index-索引" aria-hidden="true">#</a> 5 Index:索引</h5><p>包含一堆有相似结构的文档数据。 索引创建规则：</p><ul><li>仅限小写字母</li><li>不能包含1、/、*、？、&quot;、&lt;、&gt;、、#以及空格符等特殊符号</li><li>从7.0版本开始不再包含冒号</li><li>不能以、或+开头</li><li>不能超过255个字节（注意它是字节，因此多字节字符将计入255个限制）</li></ul><h5 id="_6-field-字段" tabindex="-1"><a class="header-anchor" href="#_6-field-字段" aria-hidden="true">#</a> 6 Field:字段</h5><p>就像数据库中的列(Columns),定义每个document)应该有的字段。</p><h5 id="_7type-类型" tabindex="-1"><a class="header-anchor" href="#_7type-类型" aria-hidden="true">#</a> 7Type:类型</h5><p>每个索引里都可以有一个或多个type,type是index中的一个逻辑数据分类， 一个type下的document,都有相同的field。 <strong>注意</strong>：6.0之前的版本有type（类型)概念，type相当于关系数据库的表，ES 官方将在ES9.0版本中彻底删除type。本教程ypy都为_doc。</p><h5 id="_8-shard-分片" tabindex="-1"><a class="header-anchor" href="#_8-shard-分片" aria-hidden="true">#</a> 8 shard:分片</h5><p>index数据过大时，将index.里面的数据，分为多个shard,分布式的存储在各 个服务器上面。可以支持海量数据和高并发，提升性能和吞吐量，充分利用多台机 器的cpu。</p><h5 id="_9-replica-副本" tabindex="-1"><a class="header-anchor" href="#_9-replica-副本" aria-hidden="true">#</a> 9 replica:副本</h5><p>在分布式环境下，任何一台机器都会随时宕机，如果宕机，index的一个分片 没有，导致此index不能搜索。所以，为了保证数据的安全，我们会将每个index的 分片经行备份，存储在另外的机器上。保证少数机器宕机s集群仍可以搜索。</p><p>能正常提供查询和插入的分片我们叫做主分片(primary shard),其余的我 们就管他们叫做备份的分片(replica shard)。</p><p>s6默认新建索引时，5分片，1副本，也就是一主一备，共10个分片。所以， es集群最小规模为两台。es71分片，1副本，一共2分片。</p><figure><img src="`+b+`" alt="es核心概念" tabindex="0" loading="lazy"><figcaption>es核心概念</figcaption></figure><h4 id="数据库核心概念vs-elasticsearch核心概念" tabindex="-1"><a class="header-anchor" href="#数据库核心概念vs-elasticsearch核心概念" aria-hidden="true">#</a> 数据库核心概念vs.elasticsearch核心概念</h4><table><thead><tr><th style="text-align:left;">关系型数据库（比如Mysql)<br></th><th style="text-align:left;">非关系型数据库(Elasticsearch)<br></th></tr></thead><tbody><tr><td style="text-align:left;">数据库Database<br></td><td style="text-align:left;">索引Index<br></td></tr><tr><td style="text-align:left;">表Table<br></td><td style="text-align:left;">索引Index(原为Type)<br></td></tr><tr><td style="text-align:left;">数据行Rod<br></td><td style="text-align:left;">文档Document<br></td></tr><tr><td style="text-align:left;">数据列Column<br></td><td style="text-align:left;">字段Field<br></td></tr><tr><td style="text-align:left;">约束Schema<br></td><td style="text-align:left;">映射Mapping</td></tr></tbody></table><h2 id="es快速入门" tabindex="-1"><a class="header-anchor" href="#es快速入门" aria-hidden="true">#</a> es快速入门</h2><h3 id="商品的crud" tabindex="-1"><a class="header-anchor" href="#商品的crud" aria-hidden="true">#</a> 商品的CRUD</h3><h4 id="_1-创建图书索引" tabindex="-1"><a class="header-anchor" href="#_1-创建图书索引" aria-hidden="true">#</a> 1. 创建图书索引</h4><blockquote><p>语法：PUT /index</p></blockquote><p>请求参数：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>put /book
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>响应结果：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;acknowledged&quot;</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;shards_acknowledged&quot;</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;book&quot;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-新增图书-新增文档" tabindex="-1"><a class="header-anchor" href="#_2-新增图书-新增文档" aria-hidden="true">#</a> 2. 新增图书：新增文档</h4><blockquote><p>语法：PUT /index/type/id</p></blockquote><p>请求参数</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>put /book/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Bootstrap开发&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Bootstrap是由witter:推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、S程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个Css,不受浏览器限制的精美界面css效果。&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;studymodel&quot;</span><span class="token operator">:</span> <span class="token string">&quot;201002&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">38.6</span><span class="token punctuation">,</span>
    <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2019-08-2519:11:35&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;pic&quot;</span><span class="token operator">:</span> <span class="token string">&quot;group1/M00/00/00/wKh1QFs6RCeAYOpHAAJx5ZjNDEM428.jpg&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;bootstrap&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;dev&quot;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应结果</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;book&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;result&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;created&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-根据-id查询图书-查询文档" tabindex="-1"><a class="header-anchor" href="#_3-根据-id查询图书-查询文档" aria-hidden="true">#</a> 3. 根据_id查询图书:查询文档</h4><blockquote><p>语法：GET/index/type/id</p></blockquote><p>请求参数</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>get /book/_doc/<span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>响应结果，存在</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;book&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;found&quot;</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_source&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Bootstrap开发&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;description&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Bootstrap是由witter:推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、S程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个Css,不受浏览器限制的精美界面css效果。&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;studymodel&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;201002&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;price&quot;</span> <span class="token operator">:</span> <span class="token number">38.6</span><span class="token punctuation">,</span>
    <span class="token property">&quot;timestamp&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2019-08-2519:11:35&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;pic&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;group1/M00/00/00/wKh1QFs6RCeAYOpHAAJx5ZjNDEM428.jpg&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;tags&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;bootstrap&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;dev&quot;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>响应结果不存在</p></blockquote><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;book&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;found&quot;</span> <span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-覆盖指定-id的图书-覆盖文档" tabindex="-1"><a class="header-anchor" href="#_4-覆盖指定-id的图书-覆盖文档" aria-hidden="true">#</a> 4. 覆盖指定_id的图书：覆盖文档</h4><blockquote><p>语法：PUT /index/type/id</p></blockquote><p>请求参数：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>put /book/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Bootstrap开发1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Bootstrap是由witter:推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、S程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个Css,不受浏览器限制的精美界面css效果。&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;studymodel&quot;</span><span class="token operator">:</span> <span class="token string">&quot;201002&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">38.6</span><span class="token punctuation">,</span>
    <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2019-08-2519:11:35&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;pic&quot;</span><span class="token operator">:</span> <span class="token string">&quot;group1/M00/00/00/wKh1QFs6RCeAYOpHAAJx5ZjNDEM428.jpg&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;bootstrap&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;dev&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;js&quot;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应结果：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;book&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">&quot;result&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;updated&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-修改指定-id的图书局部内容-修改文档" tabindex="-1"><a class="header-anchor" href="#_5-修改指定-id的图书局部内容-修改文档" aria-hidden="true">#</a> 5. 修改指定_id的图书局部内容：修改文档</h4><blockquote><p>语法：POST /index/type/id/_update</p></blockquote><p>请求参数：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>post /book/_doc/<span class="token number">1</span>/_update
<span class="token punctuation">{</span>
    <span class="token property">&quot;doc&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Bootstrap开发_update&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;bootstrap&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;dev&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;update&quot;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应结果：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>#! Deprecation<span class="token operator">:</span> <span class="token punctuation">[</span>types removal<span class="token punctuation">]</span> Specifying types in document update requests is deprecated<span class="token punctuation">,</span> use the endpoint /<span class="token punctuation">{</span>index<span class="token punctuation">}</span>/_update/<span class="token punctuation">{</span>id<span class="token punctuation">}</span> instead.
<span class="token punctuation">{</span>
  <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;book&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">&quot;result&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;updated&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>它提示可以改为：</p><blockquote><p>语法：POST /index/_update/id</p></blockquote><p>请求参数：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>post /book/_update/<span class="token number">1</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;doc&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Bootstrap开发_update2&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;bootstrap&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;dev&quot;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应结果：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;book&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">&quot;result&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;updated&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-删除图书-删除文档" tabindex="-1"><a class="header-anchor" href="#_6-删除图书-删除文档" aria-hidden="true">#</a> 6. 删除图书：删除文档</h4><blockquote><p>语法：DELETE /index/type/id</p></blockquote><p>请求参数：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>DELETE /book/_doc/<span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>响应结果：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;book&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">&quot;result&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;deleted&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="文档document入门" tabindex="-1"><a class="header-anchor" href="#文档document入门" aria-hidden="true">#</a> 文档Document入门</h3><h4 id="默认的自带字段解析" tabindex="-1"><a class="header-anchor" href="#默认的自带字段解析" aria-hidden="true">#</a> 默认的自带字段解析</h4><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;book&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;found&quot;</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_source&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Bootstrap开发&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;description&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Bootstrap是由witter:推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、S程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个Css,不受浏览器限制的精美界面css效果。&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;studymodel&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;201002&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;price&quot;</span> <span class="token operator">:</span> <span class="token number">38.6</span><span class="token punctuation">,</span>
    <span class="token property">&quot;timestamp&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2019-08-2519:11:35&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;pic&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;group1/M00/00/00/wKh1QFs6RCeAYOpHAAJx5ZjNDEM428.jpg&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;tags&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;bootstrap&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;dev&quot;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="index" tabindex="-1"><a class="header-anchor" href="#index" aria-hidden="true">#</a> _index</h4><ul><li>含义：此文档属于哪个索引。</li><li>原则：类似数据放在一个索引中。数据库中表的定义规则。如图书信息放在00k索。</li><li>引中，员工信息放在employee索引中。各个索存储和搜索时互不影响。 定义规则：英文小写。尽呈不要使用特殊字符。order user</li></ul><h4 id="type" tabindex="-1"><a class="header-anchor" href="#type" aria-hidden="true">#</a> _type</h4><ul><li>含义：类别。book java node。</li><li>注意：以后的es9将彻底册除此字段，所以当前版本在不断弱化type。不需要关 注。见到type都为doc。</li></ul><h4 id="id" tabindex="-1"><a class="header-anchor" href="#id" aria-hidden="true">#</a> _id</h4><ul><li>含义：文档的唯一标识。就像表的id主键。结合索引可以标识和定义一个文档。</li><li>生成：手动(put /index/_doc/id)、自动。</li></ul><h4 id="创建索引时-不同数据放到不同索引中" tabindex="-1"><a class="header-anchor" href="#创建索引时-不同数据放到不同索引中" aria-hidden="true">#</a> 创建索引时，不同数据放到不同索引中</h4><figure><img src="`+q+`" alt="不同数据放到不同索引中" tabindex="0" loading="lazy"><figcaption>不同数据放到不同索引中</figcaption></figure><h4 id="生成文档id" tabindex="-1"><a class="header-anchor" href="#生成文档id" aria-hidden="true">#</a> 生成文档id</h4><h5 id="手动生成id" tabindex="-1"><a class="header-anchor" href="#手动生成id" aria-hidden="true">#</a> 手动生成id</h5><p>参考[2. 新增图书：新增文档](#2. 新增图书：新增文档)</p><h5 id="自动生成id" tabindex="-1"><a class="header-anchor" href="#自动生成id" aria-hidden="true">#</a> 自动生成id</h5><p>白动id特点: 长度为20个字符，URL安全，base64编码，GUID,分布式生成不冲突。</p><blockquote><p>语法：POST /index/type</p></blockquote><p>请求入参：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>POST /test_index/_doc
<span class="token punctuation">{</span>
  <span class="token property">&quot;test_field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;demo&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应结果：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_index&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Fn28zYQBMWSYG3VSxZy0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;result&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;created&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="source字段" tabindex="-1"><a class="header-anchor" href="#source字段" aria-hidden="true">#</a> _source字段</h4><h5 id="source" tabindex="-1"><a class="header-anchor" href="#source" aria-hidden="true">#</a> _source</h5><p>含义：插入数据时的所有字段和值。在ge获取数据时，在_source:字段中原样返回。 GET /book/doc/1</p><h5 id="_6-3-2定制返回字段" tabindex="-1"><a class="header-anchor" href="#_6-3-2定制返回字段" aria-hidden="true">#</a> 6.3.2定制返回字段</h5><p>就像sql不要select*,而要select name,.price from book,一样。</p><blockquote><p>返回所有：GET /book/_doc/1</p></blockquote><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>{
  &quot;_index&quot; : &quot;book&quot;,
  &quot;_type&quot; : &quot;_doc&quot;,
  &quot;_id&quot; : &quot;1&quot;,
  &quot;_version&quot; : 1,
  &quot;_seq_no&quot; : 0,
  &quot;_primary_term&quot; : 1,
  &quot;found&quot; : true,
  &quot;_source&quot; : {
    &quot;name&quot; : &quot;Bootstrap开发&quot;,
    &quot;description&quot; : &quot;Bootstrap是由witter:推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、S程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个Css,不受浏览器限制的精美界面css效果。&quot;,
    &quot;studymodel&quot; : &quot;201002&quot;,
    &quot;price&quot; : 38.6,
    &quot;timestamp&quot; : &quot;2019-08-2519:11:35&quot;,
    &quot;pic&quot; : &quot;group1/M00/00/00/wKh1QFs6RCeAYOpHAAJx5ZjNDEM428.jpg&quot;,
    &quot;tags&quot; : [
      &quot;bootstrap&quot;,
      &quot;dev&quot;
    ]
  }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>定制返回字段: GET /book/_doc/1?_source_includes=name,price</p></blockquote><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;book&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_version&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_5eq_-no&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_primary_term&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;found&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_source&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">38.6</span><span class="token punctuation">,</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Bootstrap开发牧程1&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="文档的替换与删除" tabindex="-1"><a class="header-anchor" href="#文档的替换与删除" aria-hidden="true">#</a> 文档的替换与删除</h4><h5 id="全量替换" tabindex="-1"><a class="header-anchor" href="#全量替换" aria-hidden="true">#</a> 全量替换</h5><p>执行两次，返回结果中版本号(version)在不断上升。此过程为全量替换。</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT /test_index/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;test_field&quot;</span><span class="token operator">:</span><span class="token string">&quot;test&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实质：旧文档的内容不会立即删除，只是标记为deleted。适当的时机，集群会将这些文档删除。</p><figure><img src="`+h+`" alt="全量替换图" tabindex="0" loading="lazy"><figcaption>全量替换图</figcaption></figure><h5 id="强制创建" tabindex="-1"><a class="header-anchor" href="#强制创建" aria-hidden="true">#</a> 强制创建</h5><p>为防止覆盖原有数据，我们在新增时，设置为强制创建，不会覆盖原有文档。</p><p>可以用于数据库同步数据，这样可以确保数据只插入一次不会重复插入或覆盖。</p><div class="language-kibana line-numbers-mode" data-ext="kibana"><pre class="language-kibana"><code>语法：PUT /index/_doc/id/_create
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>请求入参：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT /test_index/_doc/<span class="token number">1</span>/_create
<span class="token punctuation">{</span>
    <span class="token property">&quot;test_field&quot;</span><span class="token operator">:</span><span class="token string">&quot;test&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第一次请求响应结果：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_index&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;result&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;created&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再次请求(存在数据)响应结果：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;error&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;root_cause&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;version_conflict_engine_exception&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;reason&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;[1]: version conflict, document already exists (current version [1])&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index_uuid&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ej29cxPQQ3ab2t8_U0hMkg&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;shard&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_index&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;version_conflict_engine_exception&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;reason&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;[1]: version conflict, document already exists (current version [1])&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;index_uuid&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ej29cxPQQ3ab2t8_U0hMkg&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;shard&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_index&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;status&quot;</span> <span class="token operator">:</span> <span class="token number">409</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="局部更新partial-update" tabindex="-1"><a class="header-anchor" href="#局部更新partial-update" aria-hidden="true">#</a> 局部更新partial update</h4><p>使用PUT/index/ype/id为文档全量替换，需要将文档所有数据提交。 partial update 局部替换则只修改变动字段。 用法：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>post /index/type/id/_update
<span class="token punctuation">{</span>
    <span class="token property">&quot;doc&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;value&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="图解内部原理" tabindex="-1"><a class="header-anchor" href="#图解内部原理" aria-hidden="true">#</a> 图解内部原理</h5><figure><img src="`+g+`" alt="图解局部更新内部原理" tabindex="0" loading="lazy"><figcaption>图解局部更新内部原理</figcaption></figure><p>内部与全量替换是一样的，旧文档标记为删除，新建一个文档。 优点：</p><ul><li>大大减少网络传输次数和流量，提升性能。</li><li>减少并发冲突发生的概率。</li></ul><h5 id="演示" tabindex="-1"><a class="header-anchor" href="#演示" aria-hidden="true">#</a> 演示</h5><p>[2. 新增图书：新增文档](#2. 新增图书：新增文档)</p><p>[5. 修改指定_id的图书局部内容：修改文档](#5. 修改指定_id的图书局部内容：修改文档)</p><h4 id="使用脚本更新" tabindex="-1"><a class="header-anchor" href="#使用脚本更新" aria-hidden="true">#</a> 使用脚本更新</h4><p>es可以内置脚本执行复杂操作。例如<code>painless</code>脚本。 注意：<code>groovy</code>脚本在s6以后就不支持了。原因是耗内存，不安全远程注入漏洞。</p><h5 id="内置脚本" tabindex="-1"><a class="header-anchor" href="#内置脚本" aria-hidden="true">#</a> 内置脚本</h5><p>需求1：修改文档6的num字段，+1。</p><p>插入数据:</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT /test_index/_doc/<span class="token number">6</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;num&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行脚本操作：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>POST /test_index/_doc/<span class="token number">6</span>/_update
<span class="token punctuation">{</span>
    <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ctx._source.num+=1&quot;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应结果：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>#! Deprecation<span class="token operator">:</span> <span class="token punctuation">[</span>types removal<span class="token punctuation">]</span> Specifying types in document update requests is deprecated<span class="token punctuation">,</span> use the endpoint /<span class="token punctuation">{</span>index<span class="token punctuation">}</span>/_update/<span class="token punctuation">{</span>id<span class="token punctuation">}</span> instead.
<span class="token punctuation">{</span>
  <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_index&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;6&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">&quot;result&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;updated&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查询数据：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET /test_index/_doc_6
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>响应结果：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_index&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;6&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;found&quot;</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_source&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;num&quot;</span> <span class="token operator">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>需求2：搜索所有文档，将num字段乘以2输出。</p><p>插入数据：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT /test_index/_doc/<span class="token number">7</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;num&quot;</span><span class="token operator">:</span> <span class="token number">5</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查询：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET /test_index/_search
<span class="token punctuation">{</span>
    <span class="token property">&quot;script_fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;my_doubled_field&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;lang&quot;</span><span class="token operator">:</span> <span class="token string">&quot;expression&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token string">&quot;doc[&#39;num&#39;] * multiplier&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;params&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;multiplier&quot;</span><span class="token operator">:</span> <span class="token number">2</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应结果：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;took&quot;</span> <span class="token operator">:</span> <span class="token number">33</span><span class="token punctuation">,</span>
  <span class="token property">&quot;timed_out&quot;</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;skipped&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;value&quot;</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
      <span class="token property">&quot;relation&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;eq&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;max_score&quot;</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_index&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Fn28zYQBMWSYG3VSxZy0&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_score&quot;</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
        <span class="token property">&quot;fields&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;my_doubled_field&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token number">0.0</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_index&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_score&quot;</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
        <span class="token property">&quot;fields&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;my_doubled_field&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token number">0.0</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_index&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;6&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_score&quot;</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
        <span class="token property">&quot;fields&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;my_doubled_field&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token number">4.0</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_index&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;7&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_score&quot;</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
        <span class="token property">&quot;fields&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;my_doubled_field&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token number">10.0</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="外部脚本" tabindex="-1"><a class="header-anchor" href="#外部脚本" aria-hidden="true">#</a> 外部脚本</h5><p><code>Bainless</code>是内置支持的。脚本内容可以通过多种途径传给es,包括rest接口，或者放</p><p>到config/scripts目录等，默认开启。</p><p>注意：脚本性能低下，且容易发生注入，本教程忽略。</p>`,170),D={href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting-using.html",target:"_blank",rel:"noopener noreferrer"},G=e('<h4 id="图解es的并发问题" tabindex="-1"><a class="header-anchor" href="#图解es的并发问题" aria-hidden="true">#</a> 图解ES的并发问题</h4><figure><img src="'+y+`" alt="ES并发问题" tabindex="0" loading="lazy"><figcaption>ES并发问题</figcaption></figure><p>如同秒杀场景，多线程情况下，ES同样会出现并发冲突问题。</p><h4 id="图解悲观锁与乐观锁机制" tabindex="-1"><a class="header-anchor" href="#图解悲观锁与乐观锁机制" aria-hidden="true">#</a> 图解悲观锁与乐观锁机制</h4><p>为控制并发问题，我们通常采用锁机制。分为悲观锁和乐观锁两种机制。</p><p>悲观锁：很悲观，所有情况都上锁。此时只有一个线程可以操作数据。具体例子为</p><p>数据库中的行级锁、表级锁、读锁、写锁等。</p><p>特点：优点是方便，直接加锁，对程序透明。缺点是效率低。</p><p>乐观锁：很乐观，对数据本身不加锁。提交数据时，通过一种机制验证是否存在冲</p><p>突，如es中通过版本号验证。</p><p>特点：优点是并发能力高。缺点是操作繁琐，在提交数据时，可能反复重试多次。</p><h4 id="图解es内部基于-version乐观锁控制" tabindex="-1"><a class="header-anchor" href="#图解es内部基于-version乐观锁控制" aria-hidden="true">#</a> 图解es内部基于_version乐观锁控制</h4><h5 id="实验基于-version的版本控制" tabindex="-1"><a class="header-anchor" href="#实验基于-version的版本控制" aria-hidden="true">#</a> 实验基于_version的版本控制</h5><p>es对于文档的增刷改都是基于版本号。</p><p>新增多次文档：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT /test_index/_doc/<span class="token number">3</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;test_field&quot;</span><span class="token operator">:</span><span class="token string">&quot;test&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回版本号递增：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token comment">// 新增第一次</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_index&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;result&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;created&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>

<span class="token comment">// 新增第二次</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_index&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">&quot;result&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;updated&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>删除此文档：</p><div class="language-jsom line-numbers-mode" data-ext="jsom"><pre class="language-jsom"><code>DELETE /test_index/_doc/3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>响应结果：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_index&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">&quot;result&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;deleted&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>即使是删除，也可以看到版本号依然递增，验证延迟删除策略。 如果除一条数据立马删除的话，所有分片和副本都要立马刷除，对s集群压力太 大。</p><h5 id="图解es内部主从同步并发控制" tabindex="-1"><a class="header-anchor" href="#图解es内部主从同步并发控制" aria-hidden="true">#</a> 图解es内部主从同步并发控制</h5><p>es内部主从同步时，是多线程异步。乐观锁机制。</p><figure><img src="`+_+`" alt="图解es内部主从同步并发控制" tabindex="0" loading="lazy"><figcaption>图解es内部主从同步并发控制</figcaption></figure><h4 id="批量增删改-bulk" tabindex="-1"><a class="header-anchor" href="#批量增删改-bulk" aria-hidden="true">#</a> 批量增删改 bulk</h4><p>Buk操作解释将文档的增删改查一些列操作，通过一次请求全都做完。减少网络传输</p><p>次数。</p><p>语法：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>POST /_bulk
<span class="token punctuation">{</span><span class="token property">&quot;action&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;metadata&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如下操作，删除5，新增14，修改2。</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>POST /_bulk
<span class="token punctuation">{</span><span class="token property">&quot;create&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;_index&quot;</span><span class="token operator">:</span><span class="token string">&quot;test_index&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;8&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;test_field&quot;</span><span class="token operator">:</span><span class="token string">&quot;test8&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;update&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;_index&quot;</span><span class="token operator">:</span><span class="token string">&quot;test_index&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;doc&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;test_field&quot;</span><span class="token operator">:</span><span class="token string">&quot;bulk test&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;delete&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;_index&quot;</span><span class="token operator">:</span><span class="token string">&quot;test_index&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>总结：</p><ol><li><p>功能：</p><ul><li>delete:删除一个文档，只要1个json串就可以了;</li><li>create:相当于强制创建PUT /index/type/id/_create;</li><li>index:普通的put操作，可以是创建文档，也可以是全量替换文档;</li><li>update:执行的是局部更新partial update操作;</li></ul></li><li><p>格式：每个json不能换行。相邻json必须换行。</p></li><li><p>隔离：每个操作互不影响。操作失败的行会返回其失败信息。</p></li><li><p>实际用法：buk请求一次不要太大，否则一下积压到内存中，性能会下降。所</p><p>以，一次请求几干个操作、大小在几M正好。</p></li></ol><h3 id="java-api-实现文档管理" tabindex="-1"><a class="header-anchor" href="#java-api-实现文档管理" aria-hidden="true">#</a> Java API 实现文档管理</h3><h4 id="elasticsearch-java-api" tabindex="-1"><a class="header-anchor" href="#elasticsearch-java-api" aria-hidden="true">#</a> elasticsearch java API</h4><p>之前写的整合博客。</p>`,38),R={href:"https://blog.csdn.net/weixin_43917143/article/details/120235058",target:"_blank",rel:"noopener noreferrer"},I={href:"https://www.jianshu.com/p/e1f63f2fdc55",target:"_blank",rel:"noopener noreferrer"},O=e('<h3 id="图解es内部机制" tabindex="-1"><a class="header-anchor" href="#图解es内部机制" aria-hidden="true">#</a> 图解es内部机制</h3><h4 id="图解es分布式基础" tabindex="-1"><a class="header-anchor" href="#图解es分布式基础" aria-hidden="true">#</a> 图解es分布式基础</h4><h5 id="视频" tabindex="-1"><a class="header-anchor" href="#视频" aria-hidden="true">#</a> 视频</h5>',3),H={href:"https://www.bilibili.com/video/BV1Nt4y1m7qL/?p=28&vd_source=d6cd8b3f892acbf22f02da2bfa7d95fe",target:"_blank",rel:"noopener noreferrer"},K=e('<h5 id="es对复杂分布式机制的透明隐藏特性" tabindex="-1"><a class="header-anchor" href="#es对复杂分布式机制的透明隐藏特性" aria-hidden="true">#</a> es对复杂分布式机制的透明隐藏特性</h5><ul><li>分布式机制：分布式数据存储及共享。</li><li>分片机制：数据存储到哪个分片，副本数据写入。</li><li>集群发现机制：cluster discovery。新启动es实例，自动加入集群。</li><li>shard负载均衡：大呈数据写入及查询，es会将数据平均分配。</li><li>shard副本：新增副本数，分片重分配。</li></ul><h5 id="elasticsearch的垂直扩容与水平扩容" tabindex="-1"><a class="header-anchor" href="#elasticsearch的垂直扩容与水平扩容" aria-hidden="true">#</a> Elasticsearch的垂直扩容与水平扩容</h5><p>垂直扩容：使用更加强大的服务器替代老服务器。但单机存储及运算能力有上线。</p><p>且成本直线上升。如10t服务器1万。单个10T服务器可能20万。</p><p>水平扩容：采购更多服务器，加入集群。大数据。</p><h5 id="增减或减少节点时的数据rebalance" tabindex="-1"><a class="header-anchor" href="#增减或减少节点时的数据rebalance" aria-hidden="true">#</a> 增减或减少节点时的数据rebalance</h5><p>新增或减少es实例时，es集群会将数据重新分配。</p><h5 id="master节点" tabindex="-1"><a class="header-anchor" href="#master节点" aria-hidden="true">#</a> master节点</h5><p>功能：</p><ul><li>创建别除节点；</li><li>创建删除索引；</li></ul><h5 id="节点对等的分布式架构" tabindex="-1"><a class="header-anchor" href="#节点对等的分布式架构" aria-hidden="true">#</a> 节点对等的分布式架构</h5><ul><li>节点对等，每个节点都能接收所有的请求;</li><li>自动请求路由;</li><li>响应收集;</li></ul><h5 id="示例图" tabindex="-1"><a class="header-anchor" href="#示例图" aria-hidden="true">#</a> 示例图</h5><figure><img src="'+f+'" alt="图解es分布式基础" tabindex="0" loading="lazy"><figcaption>图解es分布式基础</figcaption></figure><h4 id="图解分片shard、副本replica机制" tabindex="-1"><a class="header-anchor" href="#图解分片shard、副本replica机制" aria-hidden="true">#</a> 图解分片shard、副本replica机制</h4><h5 id="视频-1" tabindex="-1"><a class="header-anchor" href="#视频-1" aria-hidden="true">#</a> 视频</h5>',17),F={href:"https://www.bilibili.com/video/BV1Nt4y1m7qL/?p=29&spm_id_from=pageDriver&vd_source=d6cd8b3f892acbf22f02da2bfa7d95fe",target:"_blank",rel:"noopener noreferrer"},Q=e(`<h5 id="shard-replica机制" tabindex="-1"><a class="header-anchor" href="#shard-replica机制" aria-hidden="true">#</a> shard &amp; replica机制</h5><ol><li><p>每个index包，含一个或多个shard。</p></li><li><p>每个shard都是一个最小工作单元，承载部分数据，lucene实例，完整的建立</p><p>索引和处理请求的能力。</p></li><li><p>增减节点时，shard会自动在nodes中负载均衡。</p></li><li><p>primary shardi和replica shard,每个document肯定只存在于某一个primary shard以及其对应的replica shard中，不可能存在于多个primary shard。</p></li><li><p>replica shard,是primary shard的副本，负责容错，以及承担读请求负载。</p></li><li><p>primary shard的数量在创建索引的时候就固定了，replica shard的数量可以随 时修改。</p></li><li><p>primary shard的默认数量是1，replica默认是1，默认共有2个shard,1个primary shard、 1replica shard。</p><p>注意：es7以前primary shard的默认数量是5，replica默认是1，默认有10个shard,5个primary shard,5个replica shard。</p></li><li><p>primary shard不能和自己的replica shardi放在同一个节点上（否则节点宕机， primary shard和副本都丢失，起不到容错的作用)，但是可以和其他primary shard的replica shard放在同一个节点上。</p></li></ol><h4 id="图解单node环境下创建index是什么样子的" tabindex="-1"><a class="header-anchor" href="#图解单node环境下创建index是什么样子的" aria-hidden="true">#</a> 图解单node环境下创建index是什么样子的</h4><ol><li>单node环境下，创建一个index,有3个primary shard,3个replica shard。</li><li>集群status是yellow。</li><li>这个时候，只会将3个primary shard:分配到仅有的一个node上去，另外3个 replica shard是无法分配的。</li><li>集群可以正常工作，但是一旦出现节点宕机，数据全部丢失，而且集群不可用， 无法承接任何请求。</li></ol><p>请求创建索引并设置分片值：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT /test_index1
<span class="token punctuation">{</span>
    <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;number_of_shards&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token property">&quot;number_of_replicas&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应结果：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;acknowledged&quot;</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;shards_acknowledged&quot;</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_index1&quot;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建索引并设置分片值，插件可视化效果：</p><figure><img src="`+x+'" alt="设置分片插件可视化效果" tabindex="0" loading="lazy"><figcaption>设置分片插件可视化效果</figcaption></figure><h5 id="示例图-1" tabindex="-1"><a class="header-anchor" href="#示例图-1" aria-hidden="true">#</a> 示例图</h5><figure><img src="'+j+'" alt="图解单node环境下创建index是什么样子的" tabindex="0" loading="lazy"><figcaption>图解单node环境下创建index是什么样子的</figcaption></figure><h4 id="图解2个node环境下replica-shard是如何分配的" tabindex="-1"><a class="header-anchor" href="#图解2个node环境下replica-shard是如何分配的" aria-hidden="true">#</a> 图解2个node环境下replica shard是如何分配的</h4><ol><li>replica shard分配：3个primary shard, 3个replica shard, 1 node。</li><li>primary ---&gt; replica同步。</li><li>读请求：primary/replica。</li></ol><h5 id="示例图-2" tabindex="-1"><a class="header-anchor" href="#示例图-2" aria-hidden="true">#</a> 示例图</h5><figure><img src="'+E+'" alt="图解2个node环境下replica_shard是如何分配的.png" tabindex="0" loading="lazy"><figcaption>图解2个node环境下replica_shard是如何分配的.png</figcaption></figure><h4 id="图解横向扩容" tabindex="-1"><a class="header-anchor" href="#图解横向扩容" aria-hidden="true">#</a> 图解横向扩容</h4><h5 id="视频-2" tabindex="-1"><a class="header-anchor" href="#视频-2" aria-hidden="true">#</a> 视频</h5>',18),V={href:"https://www.bilibili.com/video/BV1Nt4y1m7qL/?p=31&spm_id_from=pageDriver&vd_source=d6cd8b3f892acbf22f02da2bfa7d95fe",target:"_blank",rel:"noopener noreferrer"},J=e('<ul><li>分片自动负载均衡，分片向空闲机器转移。</li><li>每个节点存储更少分片，系统资源给与每个分片的资源更多，整体集群性能提高。</li><li>扩容极限：节点数大于整体分片数，则必有空闲机器。</li><li>超出扩容极限时，可以增加副本数，如设置副本数为2，总共3*3=9个分片。9台机器同时运行，存储和搜索性能更强、容错性更好。</li><li>容错性：只要一个索引的所有主分片在，集群就就可以运行。</li></ul><h5 id="示例图-3" tabindex="-1"><a class="header-anchor" href="#示例图-3" aria-hidden="true">#</a> 示例图</h5><figure><img src="'+S+'" alt="图解横向扩容" tabindex="0" loading="lazy"><figcaption>图解横向扩容</figcaption></figure><p>当前示例图最多可挂掉6台机器，确保P0、P1、P2可以存在即可，即为R副本可以在P挂掉时存在对应的副本R进行升级为P。</p><h4 id="图解es容错机制masteri选举-replica容错-数据恢复" tabindex="-1"><a class="header-anchor" href="#图解es容错机制masteri选举-replica容错-数据恢复" aria-hidden="true">#</a> 图解es容错机制masteri选举，replica容错，数据恢复</h4><h5 id="视频-3" tabindex="-1"><a class="header-anchor" href="#视频-3" aria-hidden="true">#</a> 视频</h5>',6),Y={href:"https://www.bilibili.com/video/BV1Nt4y1m7qL?p=32&vd_source=d6cd8b3f892acbf22f02da2bfa7d95fe",target:"_blank",rel:"noopener noreferrer"},W=e('<p>以3分片，2副本数，3节点为例介绍。</p><ul><li>master node:宕机，自动masteri选举，集群为red。</li><li>replica容错：新master将replica提升为primary shard,yellow。</li><li>重启宕机node,master copy replica到该node,使用原有的shard并同步宕机后 的修改，green。</li></ul><h5 id="示例图-4" tabindex="-1"><a class="header-anchor" href="#示例图-4" aria-hidden="true">#</a> 示例图</h5><figure><img src="'+w+'" alt="图解es容错机制masteri选举，replica容错，数据恢复" tabindex="0" loading="lazy"><figcaption>图解es容错机制masteri选举，replica容错，数据恢复</figcaption></figure><h3 id="图解文档存储机制" tabindex="-1"><a class="header-anchor" href="#图解文档存储机制" aria-hidden="true">#</a> 图解文档存储机制</h3><h4 id="_9-1-数据路由" tabindex="-1"><a class="header-anchor" href="#_9-1-数据路由" aria-hidden="true">#</a> 9.1.数据路由</h4><h5 id="视频-4" tabindex="-1"><a class="header-anchor" href="#视频-4" aria-hidden="true">#</a> 视频</h5>',7),Z={href:"https://www.bilibili.com/video/BV1Nt4y1m7qL?p=33&spm_id_from=pageDriver&vd_source=d6cd8b3f892acbf22f02da2bfa7d95fe",target:"_blank",rel:"noopener noreferrer"},X=e(`<h5 id="_9-1-1文档存储如何路由到相应分片" tabindex="-1"><a class="header-anchor" href="#_9-1-1文档存储如何路由到相应分片" aria-hidden="true">#</a> 9.1.1文档存储如何路由到相应分片</h5><p>一个文档，最终会落在主分片的一个分片上，到底应该在哪一个分片？这就是数据</p><p>路由。</p><h5 id="_9-1-2路由算法" tabindex="-1"><a class="header-anchor" href="#_9-1-2路由算法" aria-hidden="true">#</a> 9.1.2路由算法</h5><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>shard hash<span class="token punctuation">(</span>routing<span class="token punctuation">)</span>%number_of_primary_shards
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>哈希值对主分片数取模。</p><p>举例：</p><p>对一个文档经行crud时，都会带一个路由值routing number。.默认为文档id(可能是</p><p>手动指定，也可能是自动生成)。</p><p>存储1号文档，经过哈希计算，哈希值为2，此索引有3个主分片，那么计算2%3=2,就算出此文档在P2分片上。</p><p>决定一个document在哪个shard.上，最重要的一个值就是routing值，默认是id,也</p><p>可以手动指定，相同的routing值，每次过来，从hash函数中，产出的hash值一定是</p><p>相同的。</p><p>无论hash值是几，无论是什么数字，对number of primary shards求余数，结果一</p><p>定是在0-number._of_primary_shards-1之间这个范围内的。0,1,2。</p><h5 id="_9-1-3手动指定routing-key" tabindex="-1"><a class="header-anchor" href="#_9-1-3手动指定routing-key" aria-hidden="true">#</a> 9.1.3手动指定routing key</h5><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT /test_index/_doc/<span class="token number">157</span>?routing=tom
<span class="token punctuation">{</span>
    <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tom&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>场景：在程序中，架构师可以手动指定已有数据的一个属性为路由值，好处是可以</p><p>定制一类文档数据存储到一个分片中。缺点是设计不好，会造成数据倾斜。</p><p>所以，不同文档尽量放到不同的索引中。剩下的事情交给s集群自己处理。</p><h5 id="_9-1-4主分片数星不可变" tabindex="-1"><a class="header-anchor" href="#_9-1-4主分片数星不可变" aria-hidden="true">#</a> 9.1.4主分片数星不可变</h5><p>涉及到以往数据的查询搜索，所以一旦建立索引，主分片数不可变。</p><h5 id="示例图-5" tabindex="-1"><a class="header-anchor" href="#示例图-5" aria-hidden="true">#</a> 示例图</h5><figure><img src="`+T+'" alt="图解文档存储机制" tabindex="0" loading="lazy"><figcaption>图解文档存储机制</figcaption></figure><h4 id="_9-2-图解文档的增删改内部机制" tabindex="-1"><a class="header-anchor" href="#_9-2-图解文档的增删改内部机制" aria-hidden="true">#</a> 9.2.图解文档的增删改内部机制</h4><h5 id="视频-5" tabindex="-1"><a class="header-anchor" href="#视频-5" aria-hidden="true">#</a> 视频</h5>',26),$={href:"https://www.bilibili.com/video/BV1Nt4y1m7qL?p=34&vd_source=d6cd8b3f892acbf22f02da2bfa7d95fe",target:"_blank",rel:"noopener noreferrer"},ss=e('<p>增删改可以看做update,都是对数据的改动。一个改动请求发送到es集群，经历以下</p><p>四个步骤：</p><ol><li>客户端选择个node发送请求过去，这个node就是coordinating node(协调节 点)。</li><li>coordinating node,对documenti进行路由，将请求转发给对应的node(有 primary shard）。</li><li>实际的node上的primary shard处理请求，然后将数据同步到replica node。</li><li>coordinating node,如果发现primary node和所有replica node都搞定之后， 就返回响应结果给客户端。</li></ol><h5 id="示例图-6" tabindex="-1"><a class="header-anchor" href="#示例图-6" aria-hidden="true">#</a> 示例图</h5><figure><img src="'+P+'" alt="图解文档的增删改内部机制" tabindex="0" loading="lazy"><figcaption>图解文档的增删改内部机制</figcaption></figure><h4 id="_9-3-图解文档的查询内部机制" tabindex="-1"><a class="header-anchor" href="#_9-3-图解文档的查询内部机制" aria-hidden="true">#</a> 9.3.图解文档的查询内部机制</h4><h5 id="视频-6" tabindex="-1"><a class="header-anchor" href="#视频-6" aria-hidden="true">#</a> 视频</h5>',7),ns={href:"https://www.bilibili.com/video/BV1Nt4y1m7qL?p=35&vd_source=d6cd8b3f892acbf22f02da2bfa7d95fe",target:"_blank",rel:"noopener noreferrer"},as=e('<ol><li>客户端发送请求到任意个node,成为coordinating node。</li><li>coordinatingnode对documenti进行路由，将请求转发到对应的node,此时会使用round-robin随机轮询算法，在primary shard以及其所有replica中随机选择一个，让读请求负载均衡。</li><li>接收请求的node返回document给coordinatingnode。</li><li>coordinatingnode返回document给客户端。</li><li>特殊情况：document如果还在建立索l过程中，可能只有primary shard有，任何一个replica shard都没有，此时可能会导致无法读取到document,但是document完成索建立之后，primary shard 和 replica shard就都有了。</li></ol><h5 id="示例图-7" tabindex="-1"><a class="header-anchor" href="#示例图-7" aria-hidden="true">#</a> 示例图</h5><figure><img src="'+z+`" alt="图解文档的查询内部机制" tabindex="0" loading="lazy"><figcaption>图解文档的查询内部机制</figcaption></figure><h4 id="_9-4-bulk-api奇特的json格式" tabindex="-1"><a class="header-anchor" href="#_9-4-bulk-api奇特的json格式" aria-hidden="true">#</a> 9.4.bulk api奇特的json格式</h4><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>POST /_bulk
<span class="token punctuation">{</span><span class="token property">&quot;action&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;meta&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>\\n
<span class="token punctuation">{</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">}</span>\\n
<span class="token punctuation">{</span><span class="token property">&quot;action&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;meta&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>\\n
<span class="token punctuation">{</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">}</span>\\n

<span class="token comment">// 正常的json应该如下，但是不符合es规范</span>
<span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token property">&quot;action&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;method&quot;</span><span class="token operator">:</span> <span class="token string">&quot;create&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token property">&quot;fieldl&quot;</span><span class="token operator">:</span> <span class="token string">&quot;java&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;field2&quot;</span><span class="token operator">:</span> <span class="token string">&quot;spring&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token property">&quot;action&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;method&quot;</span><span class="token operator">:</span> <span class="token string">&quot;create&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token property">&quot;fieldl&quot;</span><span class="token operator">:</span> <span class="token string">&quot;java&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;field2&quot;</span><span class="token operator">:</span> <span class="token string">&quot;spring&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><p>bulk中的每个操作都可能要转发到不同的node的shard去执行。</p></li><li><p>如果采用比较良好的json数组格式。</p><p>允许任意的换行，整个可读性非常棒，读起来很爽，es拿到用那种标准格式的</p><p>json串以后，要按照下述流程去进行处理：</p><p>(1) 将json数组解析为JSONArray对像，这个时候，整个数据，就会在内存中出</p><p>现一份一模一样的拷贝，一份数据是json文本，一份数据是)SONArrayi对象；</p><p>(2) 解析ison数组里的每个json,对每个请求中的document进行路由；</p><p>(3) 为路由到同一个shard.上的多个请求，创建一个请求数组。100请求中有10个是到P1； (4) 将这个请求数组序列化；</p><p>(5) 将序列化后的请求数组发送到对应的节点上去；</p></li><li><p>耗费更多内存，更多的jvm gci开销。</p><p>我们之前提到过bulk size最佳大小的那个问题，一般建议说在几千条那样，然后</p><p>大小在10MB左右，所以说，可怕的事情来了。假设说现在100个buk请求发送</p><p>到了一个节点上去，然后每个请求是10MB,100个请求，就是1000MB=1GB,然</p><p>后每个请求的json都copy一份为jsonarray对象，此时内存中的占用就会翻倍，</p><p>就会占用2GB的内存，甚至还不止。因为弄成jsonarray之后，还可能会多搞一</p><p>些其他的数据结构，2GB+的内存占用。</p><p>占用更多的内存可能就会积压其他请求的内存使用量，比如说最重要的搜索请</p><p>求，分析请求，等等，此时就可能会导致其他请求的性能急速下降。</p><p>另外的话，占用内存更多，就会导致jva虚拟机的垃圾回收次数更多，更频繁，</p><p>每次要回收的垃圾对象更多，耗费的时间更多，导致es的java虚拟机停止工作线</p><p>程的时间更多。</p></li><li><p>现在的奇特格式</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>POST /_bulk
<span class="token punctuation">{</span><span class="token property">&quot;delete&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;_index&quot;</span><span class="token operator">:</span><span class="token string">&quot;test_index&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>\\n
<span class="token punctuation">{</span><span class="token property">&quot;create&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;_index&quot;</span><span class="token operator">:</span><span class="token string">&quot;test_index&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;14&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>\\n
<span class="token punctuation">{</span><span class="token property">&quot;test_field&quot;</span><span class="token operator">:</span><span class="token string">&quot;test14&quot;</span><span class="token punctuation">}</span>\\n
<span class="token punctuation">{</span><span class="token property">&quot;update&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;_index&quot;</span><span class="token operator">:</span><span class="token string">&quot;test_index&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>\\n
<span class="token punctuation">{</span><span class="token property">&quot;doc&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;test_field&quot;</span><span class="token operator">:</span><span class="token string">&quot;bulk test&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>\\n
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(1) 不用将其转换为json对象，不会出现内存中的相同数据的拷贝，直接按照换行符切割json；</p><p>(2) 对每两个一组的json,读取meta,进行document路由；</p><p>(3 )直接将对应的json发送到node上去；</p></li><li><p>最大的优势在于，不需要将json数组解析为一个)SONArrayi对象，形成一份大</p><p>数据的拷贝，浪费内存空间，尽可能地保证性能</p></li></ol><h4 id="_10-mapping映射入门" tabindex="-1"><a class="header-anchor" href="#_10-mapping映射入门" aria-hidden="true">#</a> 10.Mapping映射入门</h4><h5 id="_10-1-什么是mapping映射" tabindex="-1"><a class="header-anchor" href="#_10-1-什么是mapping映射" aria-hidden="true">#</a> 10.1.什么是mapping映射</h5><p>概念：自动或手动为index中的_doc建立的一种数据结构和相关配置，简称为</p><p>mapping映射。</p><p>插入几条数据，让es自动为我们建立一个索引:</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT /website/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;post_date&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2019-01-01&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my first article&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;this is my first article in this website&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;author_id&quot;</span><span class="token operator">:</span> <span class="token number">11400</span>
<span class="token punctuation">}</span>

PUT /website/_doc/<span class="token number">2</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;post_date&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2019-01-02&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my second article&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;this is my second article in this website&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;author_id&quot;</span><span class="token operator">:</span> <span class="token number">11400</span>
<span class="token punctuation">}</span>

PUT /website/_doc/<span class="token number">3</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;post_date&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2019-01-03&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my third article&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;this is my third article in this website&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;author_id&quot;</span><span class="token operator">:</span> <span class="token number">11400</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对比数据库建表语句</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>create table website(
	post_date date,
	title varchar(50),
	content varchar (100),
	author_id int(11)
);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>动态映射：dynamic mapping,自动为我们建立index,以及对应mapping中包含了每</p><p>个field对应的数据类型，以及如何分词等设置。</p><p>重点：我们当然，后面会讲解，也可以手动在创建数据之前，先创建idex,以及对应</p><p>的mapping。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET /website/_mapping
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>响应结果：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;website&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;mappings&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;properties&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;author_id&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;content&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;fields&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;keyword&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;ignore_above&quot;</span> <span class="token operator">:</span> <span class="token number">256</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;post_date&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;date&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;title&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;fields&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;keyword&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;ignore_above&quot;</span> <span class="token operator">:</span> <span class="token number">256</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>尝试各种搜索</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET /website/_search?q=<span class="token number">2019</span> <span class="token number">0</span>条结果

GET /website/_search?q=<span class="token number">2019</span><span class="token number">-01</span><span class="token number">-01</span> <span class="token number">1</span>条结果

GET /website/_search?q=post_date<span class="token operator">:</span><span class="token number">2019</span><span class="token number">-01</span><span class="token number">-01</span> <span class="token number">1</span>条结果

GET /website/_search?q=post_date<span class="token operator">:</span><span class="token number">2019</span> <span class="token number">0</span>条结果

GET /website/_search?q-third <span class="token number">1</span>条结果

GET /website/_search?q=title<span class="token operator">:</span>third <span class="token number">1</span>条结果
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>搜索结果为什么不一致，因为es自动建立mapping的时候，设置了不同的field不同</p><p>的data type。</p><p>不同的data type的分词、搜索等行为是不一样的。所以出现了_all field和</p><p>post_date field的搜索表现完全不一样。</p><h4 id="_10-2-精确匹配与全文检索的对北比分析" tabindex="-1"><a class="header-anchor" href="#_10-2-精确匹配与全文检索的对北比分析" aria-hidden="true">#</a> 10.2.精确匹配与全文检索的对北比分析</h4><h5 id="_10-2-1-exact-value精确匹配" tabindex="-1"><a class="header-anchor" href="#_10-2-1-exact-value精确匹配" aria-hidden="true">#</a> 10.2.1 exact value精确匹配</h5><p>2019-01-01, exact value, 搜索的时候，必须输入2019-01-01，才能搜索出来</p><p>如果你输入一个01，是搜索不出来的。ype=date时，是精确匹配。</p><p>select from book where post date=&#39;2019-01-01&#39;</p><h5 id="_10-2-2-full-text全文检索" tabindex="-1"><a class="header-anchor" href="#_10-2-2-full-text全文检索" aria-hidden="true">#</a> 10.2.2 full text全文检索</h5><p>搜笔记电脑”，笔记本电脑词条会不会出现。</p><p>select*from book where name like&#39;%笔记电脑%&#39;</p><p>(1)缩写vs.全称：cnvs.china</p><p>(2)格式转化：like liked likes</p><p>(3)大小写：Tom vs tom</p><p>(4)同义词：like vs love</p><p>2019-01-01,20190101,搜索2019，或者01，都可以搜索出来</p><p>china,搜索cn,也可以将china搜索出来</p><p>likes,搜索ike,也可以将ikes搜索出来</p><p>Tom,搜索tom,也可以将Tom搜索出来</p><p>Iike,搜索love,同义词，也可以将ike搜索出来</p><p>就不是说单纯的只是匹配完整的一个值，而是可以对值进行拆分词语后（分词）进</p><p>行匹配，也可以通过缩写、时态、大小写、同义词等进行匹配。深入NPL,自然语义</p><p>处理。</p><h4 id="_10-3·全文检索下倒排索引核心原理快速揭秘" tabindex="-1"><a class="header-anchor" href="#_10-3·全文检索下倒排索引核心原理快速揭秘" aria-hidden="true">#</a> 10.3·全文检索下倒排索引核心原理快速揭秘</h4><p>doc1 ：I really liked my small dogs,and I think my mom also liked them.</p><p>doc2 ：He never liked any dogs,so I hope that my mom will not expect me to liked him.</p><h5 id="分词-初步的倒排索引的建立" tabindex="-1"><a class="header-anchor" href="#分词-初步的倒排索引的建立" aria-hidden="true">#</a> 分词，初步的倒排索引的建立</h5><table><thead><tr><th>term</th><th>doc1</th><th>doc2</th></tr></thead><tbody><tr><td>I</td><td>*</td><td>*</td></tr><tr><td>really</td><td>*</td><td></td></tr><tr><td>liked</td><td>*</td><td>*</td></tr><tr><td>my</td><td>*</td><td>*</td></tr><tr><td>small</td><td>*</td><td></td></tr><tr><td>dogs</td><td>*</td><td></td></tr><tr><td>and</td><td>*</td><td></td></tr><tr><td>think</td><td>*</td><td></td></tr><tr><td>mom</td><td>*</td><td>*</td></tr><tr><td>also</td><td>*</td><td></td></tr><tr><td>them</td><td>*</td><td></td></tr><tr><td>He</td><td></td><td>*</td></tr><tr><td>never</td><td></td><td>*</td></tr><tr><td>any</td><td></td><td>*</td></tr><tr><td>so</td><td></td><td>*</td></tr><tr><td>hope</td><td></td><td>*</td></tr><tr><td>that</td><td></td><td>*</td></tr><tr><td>will</td><td></td><td>*</td></tr><tr><td>not</td><td></td><td>*</td></tr><tr><td>expect</td><td></td><td>*</td></tr><tr><td>me</td><td></td><td>*</td></tr><tr><td>to</td><td></td><td>*</td></tr><tr><td>him</td><td></td><td>*</td></tr></tbody></table><p>演示了一下倒排索引最简单的建立的一个过程</p><h5 id="搜索" tabindex="-1"><a class="header-anchor" href="#搜索" aria-hidden="true">#</a> 搜索</h5><p>mother like little dog,不可能有任何结果</p><p>mother</p><p>like</p><p>little</p><p>dog</p><p>这不是我们想要的结果。同义词mom\\mother在我们人类看来是一样。想进行标</p><p>准化操作。</p><h5 id="重建倒排索引" tabindex="-1"><a class="header-anchor" href="#重建倒排索引" aria-hidden="true">#</a> 重建倒排索引</h5><p>normalization正规化，建立倒排索引的时候，会执行一个操作，也就是说对拆分出</p><p>的各个单词进行相应的处理，以提升后面搜索的时候能够搜索到相关联的文档的概</p><p>率。</p><p>时态的转换，单复数的转换，同义词的转换，大小写的转换</p><p>mom ---&gt; mother</p><p>liked ---&gt; like</p><p>small ---&gt; little</p><p>dogs ---&gt; dog</p><p>重新建立倒排索引，加入normalization,再次用mother liked little dog搜索，就可以</p><p>搜索到了。</p><table><thead><tr><th>term</th><th>doc1</th><th>doc2</th><th>normalization</th></tr></thead><tbody><tr><td>I</td><td>*</td><td>*</td><td></td></tr><tr><td>really</td><td>*</td><td></td><td></td></tr><tr><td>like</td><td>*</td><td>*</td><td>liked ---&gt; like</td></tr><tr><td>my</td><td>*</td><td>*</td><td></td></tr><tr><td>little</td><td>*</td><td></td><td>small ---&gt; little</td></tr><tr><td>dog</td><td>*</td><td></td><td>dogs ---&gt; dog</td></tr><tr><td>and</td><td>*</td><td></td><td></td></tr><tr><td>think</td><td>*</td><td></td><td></td></tr><tr><td>mother</td><td>*</td><td>*</td><td>mom ---&gt; mother</td></tr><tr><td>also</td><td>*</td><td></td><td></td></tr><tr><td>them</td><td>*</td><td></td><td></td></tr><tr><td>He</td><td></td><td>*</td><td></td></tr><tr><td>never</td><td></td><td>*</td><td></td></tr><tr><td>any</td><td></td><td>*</td><td></td></tr><tr><td>so</td><td></td><td>*</td><td></td></tr><tr><td>hope</td><td></td><td>*</td><td></td></tr><tr><td>that</td><td></td><td>*</td><td></td></tr><tr><td>will</td><td></td><td>*</td><td></td></tr><tr><td>not</td><td></td><td>*</td><td></td></tr><tr><td>expect</td><td></td><td>*</td><td></td></tr><tr><td>me</td><td></td><td>*</td><td></td></tr><tr><td>to</td><td></td><td>*</td><td></td></tr><tr><td>him</td><td></td><td>*</td><td></td></tr></tbody></table><h5 id="重新搜索" tabindex="-1"><a class="header-anchor" href="#重新搜索" aria-hidden="true">#</a> 重新搜索</h5><p>搜索：mother liked little dog, 对搜索条件经行分词normalization</p><p>mother</p><p>liked-》like</p><p>little</p><p>dog</p><p>doc1和doc2都会搜索出来！</p><h4 id="_10-4-分词器analyzer" tabindex="-1"><a class="header-anchor" href="#_10-4-分词器analyzer" aria-hidden="true">#</a> 10.4.分词器analyzer</h4><h5 id="_10-4-1-什么是分词器analyzer" tabindex="-1"><a class="header-anchor" href="#_10-4-1-什么是分词器analyzer" aria-hidden="true">#</a> 10.4.1 什么是分词器analyzer</h5><p>作用：切分词语，normalization(提升recall召回率)</p><p>给es一段句子，然后将这段句子拆分成一个一个的单个的单词，同时对每个单词进</p><p>行normalization(时态转换，单复数转换)</p><p>recall,召回率：搜索的时候，增加能够搜索到的结果的数量</p><p>analyzer 3个组成部分、步骤：</p><ol><li><p>character filter:在一段文本进行分词之前，先进行预处理，比如说最常见的就</p><p>是，过滤html标签(<code>&lt;span&gt;hello&lt;span&gt;</code>-&gt;hello), &amp;-&gt;and ( l&amp;you ---&gt; I and you）。</p></li><li><p>tokenizer:分词，hello you and me- --&gt; hello,you,and,me。</p></li><li><p>token filter lowercase stop word synonymom dogs ---&gt; dog,liked ---&gt;</p><p>like,Tom ---&gt; tom,a/the/an-&gt;干掉，mother ---&gt; mom,small ---&gt; little</p><p>stop word 停用词：了 的 呢。</p></li></ol><p>一个分词器，很重要，将一段文本进行各种处理，最后处理好的结果才会拿去建立</p><p>倒排索引。</p><h5 id="_10-4-2-内置分词器的介绍" tabindex="-1"><a class="header-anchor" href="#_10-4-2-内置分词器的介绍" aria-hidden="true">#</a> 10.4.2 内置分词器的介绍</h5><p>例句：Set the shape to semi--transparent by calling set_trans(S)</p><p>standard analyzer标准分词器：set,the,shape,to,semi,transparent,,by,calling,set_trans,5(默认的是standard)</p><p>simple analyzeri简单分词器：set,the,shape,to,semi,transparent,by,calling,set,trans</p><p>whitespace analyzer Set,the,shape,to,semi-transparent,by,calling,set_trans(5)</p><p>language analyzer(特定的语言的分词器，比如说，english,英语分词器)：set,shape,semi,transpar,call,set_tran,5</p><p>官方文档地址：</p>`,97),ts={href:"https://www.elastic.co/guide/en/elasticsearch/reference/7.7/analysis-analyzers.html",target:"_blank",rel:"noopener noreferrer"},es=e(`<h4 id="_10-5-query-string根据字段分词策略" tabindex="-1"><a class="header-anchor" href="#_10-5-query-string根据字段分词策略" aria-hidden="true">#</a> 10.5.query string根据字段分词策略</h4><h5 id="_10-5-1-query-string-分词" tabindex="-1"><a class="header-anchor" href="#_10-5-1-query-string-分词" aria-hidden="true">#</a> 10.5.1 query string:分词</h5><p>query string必须以和index建立时相同的analyzeri进行分词</p><p>query string对exact value和full text的区别对待</p><p>如：date:exact value精确匹配</p><p>text:full text全文检索</p><h5 id="_10-5-2测试分词器" tabindex="-1"><a class="header-anchor" href="#_10-5-2测试分词器" aria-hidden="true">#</a> 10.5.2测试分词器</h5><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET /_analyze
<span class="token punctuation">{</span>
    <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;standard&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;text&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Text to analyze 70&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应结果：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;tokens&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;to&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;analyze&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;70&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&lt;NUM&gt;&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,10);function ps(os,is){const a=r("ExternalLinkIcon");return o(),i("div",null,[B,A,s("p",null,[n("ELK是一个免费开源的日志分析架构技术栈总称，"),s("a",M,[n("官网"),t(a)]),n("。包含三大基础组件，分别是Elasticsearch、Logstash、Kibana。但实际上ELK 不仅仅适用于日志分析，它还可以支持其它任何数据搜索、分析和收集的场景，日 志分析和收集只是更具有代表性。并非唯一性。下面是ELK架构：")]),N,s("p",null,[n("ElasticSearch:是一个基于Lucene的搜索服务器。它提供了一个分布式多用户 能力的全文搜索引擎，基于RESTful web 接口。 "),s("a",U,[n("官网"),t(a)])]),C,s("p",null,[n("官方文档："),s("a",D,[n("https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting-using.html"),t(a)])]),G,s("p",null,[n("CSDN："),s("a",R,[n("(71条消息) spring-boot 整合elasticsearch 7.x(简单入门含gitee源码)_meng前行的博客-CSDN博客_springboot整合elasticsearch7"),t(a)])]),s("p",null,[n("简书："),s("a",I,[n("spring-boot 整合elasticsearch 7.x(简单入门含gitee源码) - 简书 (jianshu.com)"),t(a)])]),O,s("p",null,[s("a",H,[n("day2-09-图解es分布式基础_哔哩哔哩_bilibili"),t(a)])]),K,s("p",null,[s("a",F,[n("day2-10-图解分片shard、副本replica机制_哔哩哔哩_bilibili"),t(a)])]),Q,s("p",null,[s("a",V,[n("day2-12-图解横向扩容_哔哩哔哩_bilibili"),t(a)])]),J,s("p",null,[s("a",Y,[n("day2-13- 图解es容错机制 master选举，replica容错，数据恢复_哔哩哔哩_bilibili"),t(a)])]),W,s("p",null,[s("a",Z,[n("day2-14-数据路由_哔哩哔哩_bilibili"),t(a)])]),X,s("p",null,[s("a",$,[n("day2-15-图解文档的增删改内部机制_哔哩哔哩_bilibili"),t(a)])]),ss,s("p",null,[s("a",ns,[n("day2-16-图解文档的查询内部机制_哔哩哔哩_bilibili"),t(a)])]),as,s("p",null,[n("[Built-in analyzer reference | Elasticsearch Guide "),s("a",ts,[n("7.7] | Elastic"),t(a)])]),es])}const ls=p(L,[["render",ps],["__file","ElasticStack.html.vue"]]);export{ls as default};
